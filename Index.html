<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Twinrender – Shop</title>
  <link rel="preconnect" href="https://js.stripe.com">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{margin:0;background:#0b0f1a;color:#e7edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;background:#0f1628;border-bottom:1px solid rgba(255,255,255,.08)}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px}
    .card{background:#0f1628;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden}
    .card img{width:100%;height:170px;object-fit:cover;display:block;background:#111728}
    .pad{padding:14px}
    .title{font-weight:600;margin:0 0 6px}
    .price{opacity:.8;margin:0 0 10px}
    button{border:0;border-radius:10px;background:#6b8bff;color:white;font-weight:600;padding:10px 14px;cursor:pointer}
    button.secondary{background:#1b2540}
    aside.cart{position:fixed;top:0;right:0;width:360px;max-width:90vw;height:100dvh;background:#0f1628;border-left:1px solid rgba(255,255,255,.08);transform:translateX(100%);transition:.25s;display:flex;flex-direction:column}
    aside.cart.open{transform:translateX(0)}
    .cart-head{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .cart-body{padding:12px;gap:10px;display:flex;flex-direction:column;overflow:auto}
    .cart-item{display:flex;gap:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;background:#0b1224}
    .cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px;background:#111728}
    .right{margin-left:auto;text-align:right}
    .input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:#0b1224;color:#e7edf6}
    .total{margin:8px 0 14px;font-weight:700}
    .muted{opacity:.75}
    .badge{font-size:12px;background:#1b2540;padding:4px 8px;border-radius:999px;margin-left:8px}
    .footer-note{opacity:.6;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
<header>
  <h1>Twinrender <span class="badge" id="modeBadge"></span></h1>
  <button id="openCart">Your cart</button>
</header>

<div class="wrap">
  <h2>Twinmotion Scenes – Ready to Render</h2>
  <p class="muted">Add a scene to your cart, fill in your email & name, pay via Stripe, and the download starts automatically.</p>

  <div class="grid" id="productGrid"></div>
</div>

<aside class="cart" id="cart">
  <div class="cart-head">
    <strong>Your cart</strong>
    <button class="secondary" id="closeCart">Close</button>
  </div>
  <div class="cart-body">
    <div id="cartItems"></div>

    <div class="muted">Name</div>
    <input class="input" id="buyerName" placeholder="Your name"/>
    <div class="muted">Email</div>
    <input class="input" id="buyerEmail" placeholder="you@example.com"/>

    <div class="total" id="totalLabel">Total: € 0.00</div>
    <button id="checkoutBtn">Checkout</button>
    <div class="footer-note" id="msg"></div>
  </div>
</aside>

<script>
/* ============================
   1) SIMPLE TEST/LIVE TOGGLE
   ============================ */
const MODE = "test"; // <<< "test" of "live"
document.getElementById('modeBadge').textContent = MODE.toUpperCase();

const STRIPE_PUBLISHABLE = {
  test: "pk_test_51RxuD8HoOWyFBTgUahIOlF5pVwHqjSoGiG14HULLaNbso9zK9LtOtSOhuDZVReOt1gAusMPKJGT6UoSGBoejozvM00kSsc8Qvr",
  live: "pk_live_51RxuD8HoOWyFBTgU1X8zPjcFWis7i0tbg0tGmxcxvaoYYJBMct84LRKCBzswNZcAHGv8uOLCCrxy2KXmsttFhLOz003YcvJZjL"
};
const stripe = Stripe(STRIPE_PUBLISHABLE[MODE]);

/* ============================
   2) PRODUCTS
   - fileId = je Google Drive fileId
   - filename = gewenste bestandsnaam bij downloaden
   ============================ */
const PRODUCTS = [
  {
    id: "RT-0001",
    title: "Rooftop Terras (Twinmotion)",
    price: 29.00,
    img: "images/rooftop-terras.jpg",
    fileId: "1oOgTasMp1O11TNoixu4ScY3v4unceO6V",
    filename: "Rooftop-Terras.zip"
  }
];

/* ======= CART RUNTIME ======= */
const productGrid = document.getElementById('productGrid');
const cartEl = document.getElementById('cart');
const cartItemsEl = document.getElementById('cartItems');
const totalLabel = document.getElementById('totalLabel');
const msg = document.getElementById('msg');

let cart = []; // {id, title, price, img, fileId, filename}

function renderProducts(){
  productGrid.innerHTML = PRODUCTS.map(p => `
    <div class="card">
      <img src="${p.img}" alt="">
      <div class="pad">
        <div class="title">${p.title}</div>
        <div class="price">€ ${p.price.toFixed(2)}</div>
        <button onclick='addToCart("${p.id}")'>Buy</button>
      </div>
    </div>
  `).join('');
}
renderProducts();

function addToCart(id){
  const p = PRODUCTS.find(x=>x.id===id);
  if(!p) return;
  cart.push({...p});
  openCart();
  renderCart();
}
function removeFromCart(i){
  cart.splice(i,1);
  renderCart();
}
function renderCart(){
  if(cart.length===0){
    cartItemsEl.innerHTML = `<div class="muted">Your cart is empty.</div>`;
    totalLabel.textContent = `Total: € 0.00`;
    return;
  }
  cartItemsEl.innerHTML = cart.map((c,i)=>`
    <div class="cart-item">
      <img src="${c.img || ''}">
      <div>
        <div><strong>${c.title}</strong></div>
        <div class="muted">€ ${c.price.toFixed(2)}</div>
      </div>
      <div class="right">
        <button class="secondary" onclick="removeFromCart(${i})">Remove</button>
      </div>
    </div>
  `).join('');
  const total = cart.reduce((s,x)=>s+x.price,0);
  totalLabel.textContent = `Total: € ${total.toFixed(2)}`;
}
function openCart(){ cartEl.classList.add('open'); }
function closeCart(){ cartEl.classList.remove('open'); }
document.getElementById('openCart').onclick=openCart;
document.getElementById('closeCart').onclick=closeCart;

/* ============================
   3) CHECKOUT FLOW
   - Stuurt items naar Netlify functie
   - Stripe redirect
   - Fallback: ga toch naar success.html om download te testen
   ============================ */
document.getElementById('checkoutBtn').addEventListener('click', async ()=>{
  msg.textContent='';
  const name = document.getElementById('buyerName').value.trim();
  const email = document.getElementById('buyerEmail').value.trim();
  if(!cart.length){ msg.textContent = "Your cart is empty."; return;}
  if(!email){ msg.textContent = "Please enter your email."; return;}

  // Sla bestelling op voor success-pagina (download)
  localStorage.setItem('lastOrder', JSON.stringify(cart));

  try{
    const res = await fetch('/.netlify/functions/create-checkout', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        mode: MODE,
        items: cart.map(c => ({title:c.title, price:c.price, qty:1})),
        customer: {name, email},
        successUrl: location.origin + '/success.html',
        cancelUrl: location.href
      })
    });

    if(!res.ok){
      throw new Error(await res.text());
    }
    const {id} = await res.json();
    const result = await stripe.redirectToCheckout({ sessionId: id });
    if(result.error) throw result.error;

  }catch(err){
    console.warn('Checkout error, going to success test flow:', err);
    // Test zonder betaling
    location.href = 'success.html';
  }
});
</script>
</body>
</html>
